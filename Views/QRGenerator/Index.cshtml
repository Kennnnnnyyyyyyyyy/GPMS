@{
    ViewData["Title"] = "QR Code Generator";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-qrcode me-2"></i>
                        Visitor Intake QR Code Generator
                    </h4>
                    <p class="mb-0 mt-2">Generate QR codes for public visitor registration</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Generate QR Code</h5>
                            <form id="qrGeneratorForm">
                                <div class="mb-3">
                                    <p class="text-muted">Generate QR code for visitor registration</p>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-qrcode me-2"></i>Generate QR Code
                                </button>
                            </form>
                            
                            <div id="urlInfo" class="mt-4" style="display: none;">
                                <h6>Registration URL:</h6>
                                <div class="input-group">
                                    <input type="text" id="generatedUrl" class="form-control" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyUrl()">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Share this URL with visitors or display the QR code</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="qrCodeContainer" style="display: none;">
                                <h5>Generated QR Code</h5>
                                <div class="text-center">
                                    <div id="qrCodeDisplay" class="border p-3 bg-white">
                                        <!-- QR code will be displayed here -->
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary me-2" onclick="downloadQR()">
                                            <i class="fas fa-download me-1"></i>Download
                                        </button>
                                        <button class="btn btn-info" onclick="printQR()">
                                            <i class="fas fa-print me-1"></i>Print
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>How to use QR codes:</h6>
                                <ul class="mb-0">
                                    <li><strong>Print and Display:</strong> Place QR codes at reception desks, entrance gates, or visitor areas</li>
                                    <li><strong>Digital Sharing:</strong> Share the registration URL via email, WhatsApp, or SMS</li>
                                    <li><strong>Instructions for Visitors:</strong> Ask visitors to scan the QR code with their phone camera</li>
                                    <li><strong>Direct Access:</strong> The QR code will take visitors directly to the registration form</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print Modal -->
<div class="modal fade" id="printModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Print QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="printContent">
                <!-- Print content will be generated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentQRData = null;
        let currentSiteName = 'Main Office';

        document.getElementById('qrGeneratorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateQR();
        });

        function generateQR() {
            fetch('@Url.Action("GenerateIntakeQR")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: new URLSearchParams({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayQR(data.qrCodeBase64, data.intakeUrl);
                } else {
                    alert('Error generating QR code: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating the QR code');
            });
        }

        function displayQR(qrCodeBase64, intakeUrl) {
            currentQRData = {
                base64: qrCodeBase64,
                url: intakeUrl
            };
            
            document.getElementById('generatedUrl').value = intakeUrl;
            document.getElementById('qrCodeDisplay').innerHTML = 
                `<img src="data:image/png;base64,${qrCodeBase64}" alt="QR Code" style="max-width: 300px;">`;
            
            document.getElementById('urlInfo').style.display = 'block';
            document.getElementById('qrCodeContainer').style.display = 'block';
        }

        function copyUrl() {
            const urlInput = document.getElementById('generatedUrl');
            urlInput.select();
            document.execCommand('copy');
            
            // Show temporary feedback
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 1000);
        }

        function downloadQR() {
            if (!currentQRData) return;
            
            const link = document.createElement('a');
            link.download = `visitor-qr-${currentSiteName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}.png`;
            link.href = `data:image/png;base64,${currentQRData.base64}`;
            link.click();
        }

        function printQR() {
            if (!currentQRData) return;
            
            const printContent = document.getElementById('printContent');
            printContent.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h2>Visitor Registration</h2>
                    <h4>${currentSiteName}</h4>
                    <div style="margin: 30px 0;">
                        <img src="data:image/png;base64,${currentQRData.base64}" 
                             alt="QR Code" style="width: 300px; height: 300px;">
                    </div>
                    <h5>Scan to Register Your Visit</h5>
                    <p>Point your phone camera at this QR code<br>to access the visitor registration form</p>
                    <div style="margin-top: 30px; font-size: 12px; color: #666;">
                        <p>Direct URL: ${currentQRData.url}</p>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('printModal'));
            modal.show();
        }

        // Print styles
        const printStyles = `
            <style>
                @@media print {
                    body * { visibility: hidden; }
                    #printContent, #printContent * { visibility: visible; }
                    #printContent { 
                        position: absolute; 
                        left: 0; 
                        top: 0; 
                        width: 100%; 
                        text-align: center;
                    }
                    .modal { display: none !important; }
                }
            </style>
        `;
        document.head.insertAdjacentHTML('beforeend', printStyles);
    </script>
}
